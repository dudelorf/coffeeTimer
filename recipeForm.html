<!DOCTYPE html>
<head>
	<title>New Recipe</title>
	<link rel="stylesheet" type="text/css" href="styles/phaseForm.css" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script src="lib/handlebars-v3.0.1.js"></script>
	<script id="volOptionTemplate" type="text/x-handlebars-template">
		<option value={{volume}}> {{volume}} </option></script>
	<script id="phaseFormTemplate" type="text/x-handlebars-template">
		<tbody class="phaseField" id="phase{{phaseNum}}">
		<tr class="phaseMemo">
			<td>Phase Memo</td>
			<td><input type="text" placeholder={{initPlaceholder}} id="memop{{phaseNum}}" name="memop{{phaseNum}}"></input></td>
		</tr>
		<tr class="phaseData">
		<td>Phase Length</td>
		<td>
			<select name="minutesp{{phaseNum}}" id="minutesp{{phaseNum}}">
				<option value="0"> 0 </option>
				<option value="1"> 1 </option>
				<option value="2"> 2 </option>
				<option value="3"> 3 </option>
				<option value="4"> 4 </option>
				<option value="5"> 5 </option>
			</select> : 
			<select name="secondsp{{phaseNum}}" id="secondsp{{phaseNum}}">
				<option value="0"> 00 </option>
				<option value="15"> 15 </option>
				<option value="30" selected="true"> 30 </option>
				<option value="45"> 45 </option>
			</select>
			<div class="removePhaseButton" id="removep{{phaseNum}}"> Remove phase </div>
		</td>
		</tr>
		</tbody>
		
	</script>
	<script>
		var phaseFormTemplate;
		$(document).ready(function(){
			var volOptionTemplate = Handlebars.compile($("#volOptionTemplate").html());
			var outputStr = "";
			var context = {};
			for (var vol = 7; vol < 32; vol++)
			{
				context = {volume: vol};
				outputStr += volOptionTemplate(context);
			}
			$("#volSelect").append(outputStr);
			
			//add initial phases
			phaseFormTemplate = Handlebars.compile($("#phaseFormTemplate").html());
			var initPhases = [
					{phaseNum: 1,
					 initPlaceholder: "Bloom"},
					{phaseNum: 2,
					 initPlaceholder: "Pour"},
					{phaseNum: 3,
					 initPlaceholder: "Drawdown"}
				];
			for (var p=0; p < initPhases.length; p++)
			{
				context = initPhases[p];
				addPhase(context);
			}
		});
		
		function removePhase(phaseNumber)
		//removes phase supplied as phaseNumber and re-indexes phase fields if necessary
		{
			alert(phaseNumber);
			var totalPhases = document.getElementsByClassName("phaseField").length;
			if(phaseNumber < totalPhases)
			//re-indexing is required
			{
				$("#phase" + phaseNumber).remove();
				totalPhases--;
				while(phaseNumber <= totalPhases)
				{
					$("#phase" + (phaseNumber + 1)).attr("id", "phase" + phaseNumber);
					$("#memop" + (phaseNumber + 1)).attr("id", "memop" + phaseNumber).attr("name", "memop" + phaseNumber);
					$("#minutesp" + (phaseNumber + 1)).attr("id", "minutesp" + phaseNumber).attr("name", "minutesp" + phaseNumber);
					$("#secondsp" + (phaseNumber + 1)).attr("id", "secondsp" + phaseNumber).attr("name", "secondsp" + phaseNumber);
					(function(phaseNumber){
						$("#removep" + (phaseNumber + 1)).attr("id", "removep" + phaseNumber)
						.off("click").on("click", function(){removePhase(phaseNumber);});
						}(phaseNumber));
					phaseNumber++;
				}
			}
			else
			{
				$("#phase" + phaseNumber).remove();
			}
			
		}
		
		function addPhase(context)
		//builds html for phase field and adds it to form
		{
			$("#formTable").append(phaseFormTemplate(context));
			$("#removep" + context.phaseNum).on("click", function(){removePhase(context.phaseNum);});
		}
		
		function addNewPhase(){
		//adds a new phase field to form
			var newPhaseNumber = document.getElementsByClassName("phaseField").length + 1;
			var context = {phaseNum: newPhaseNumber,
						   initPlaceholder: "New Phase"};
			addPhase(context);
		}
	</script>
</head>
<body>
	<form action="processRecipe.php" method="POST">
		<table border="2px" id="formTable">
		<tr>
			<td>Method Name</td>
			<td><input type="text" size="40" placeholder="My Chemex"></input></td>
		</tr>
		<tr>
			<td>Default Volume</td>
			<td><select id="volSelect"></select> Oz</td>
		</tr>
		<tr>
			<td>Brew Ratio</td>
			<td><input type="text" size="4" placeholder="15" ></input>
			. <input type="text" size="3" placeholder="0" ></input>g coffee/mL water</td>
		</tr>
		<tr><td colspan="2" style="text-align:center">Brew Phases</td></tr>
		</table>
	</form>
	<div onclick="addNewPhase()">New Phase</div>
	<div id="submitThatBioch" style="
								width:200px;
								height:100px;
								color:white;
								background-color:green;
								text-align:center;
								vertical-align:middle;
								line-height:100px;">Save Recipe</div>
</body>
</html>